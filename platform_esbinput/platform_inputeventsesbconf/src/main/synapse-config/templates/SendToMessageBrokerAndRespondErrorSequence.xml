<?xml version="1.0" encoding="UTF-8"?>
<template xmlns="http://ws.apache.org/ns/synapse" name="SendToMessageBrokerAndRespondErrorSequence">
    <parameter name="mb_url"/>
    <parameter name="mb_user"/>
    <parameter name="mb_pwd"/>
    <parameter name="mb_destination_name"/>
    <parameter name="mb_destination_type"/>
    <parameter name="error_name"/>
    <parameter name="error_code"/>
    <sequence>
        <clone>
            <target>
                <sequence>
                    <call-template target="SendToMessageBrokerSequence" description="">
                        <with-param name="mb_url" value="{$func:mb_url}"/>
                        <with-param name="mb_user" value="{$func:mb_user}"/>
                        <with-param name="mb_pwd" value="{$func:mb_pwd}"/>
                        <with-param name="mb_destination_name" value="{$func:mb_destination_name}"/>
                        <with-param name="mb_destination_type" value="{$func:mb_destination_type}"/>
                    </call-template>
                    <send/>
                </sequence>
            </target>
            <target>
                <sequence>
                    <property name="HTTP_SC" value="500" scope="axis2" type="STRING"/>
                    <payloadFactory media-type="json">
                        <format>{
  "error_name": "$1",
  "error_code": "$2",
  "output": "$3"
}</format>
                        <args>
                            <arg evaluator="xml" expression="$func:error_name"/>
                            <arg evaluator="xml" expression="$func:error_code"/>
                            <arg evaluator="xml" expression="$func:mb_destination_name"/>
                        </args>
                    </payloadFactory>
                    <respond/>
                </sequence>
            </target>
        </clone>
    </sequence>
</template>
