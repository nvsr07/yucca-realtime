<?xml version="1.0" encoding="UTF-8"?>
<api xmlns="http://ws.apache.org/ns/synapse" name="tenant1_http" context="/wso001/services/ten1">
    <resource methods="POST" uri-template="/{streamId}">
        <inSequence>
            <log level="full">
                <property name="streamId_src" expression="get-property('uri.var.streamId')"/>
                <property name="sequence" value="IN"/>
            </log>
            <call-template target="SendToMessageBrokerSequence" description="">
                <with-param name="mb_url" value="mb.internal.jms.url"/>
                <with-param name="mb_user" value="mb.internal.user"/>
                <with-param name="mb_pwd" value="mb.internal.pwd"/>
                <with-param name="mb_destination_name" value="@obrace@fn:concat('input.ten1.',fn:get-property('uri.var.streamId'))@cbrace@"/>
                <with-param name="mb_destination_type" value="queue"/>
            </call-template>
            <property name="FORCE_SC_ACCEPTED" value="true" scope="axis2" type="STRING"/>
            <send/>
        </inSequence>
        <outSequence>
            <log level="full">
                <property name="streamId" expression="get-property('uri.var.streamId')"/>
                <property name="sequence" value="OUT"/>
            </log>
        </outSequence>
        <faultSequence>
            <clone continueParent="true">
                <target>
                    <sequence>
                        <call-template target="SendToMessageBrokerSequence" description="">
                            <with-param name="mb_url" value="mb.external.jms.url"/>
                            <with-param name="mb_user" value="mb.external.user"/>
                            <with-param name="mb_pwd" value="mb.external.pwd"/>
                            <with-param name="mb_destination_name" value="@obrace@@obrace@fn:concat('ten1.','errors')@cbrace@@cbrace@"/>
                            <with-param name="mb_destination_type" value="topic"/>
                        </call-template>
                        <send/>
                    </sequence>
                </target>
            </clone>
            <log level="full">
                <property name="streamId" expression="get-property('uri.var.streamId')"/>
                <property name="sequence" value="FAULT"/>
                <property name="message" expression="get-property('ERROR_MESSAGE')"/>
            </log>
            <property name="HTTP_SC" value="500" scope="axis2" type="STRING"/>
            <respond/>
        </faultSequence>
    </resource>
</api>
