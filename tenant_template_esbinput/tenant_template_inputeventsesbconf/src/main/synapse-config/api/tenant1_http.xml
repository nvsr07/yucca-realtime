<?xml version="1.0" encoding="UTF-8"?>
<api xmlns="http://ws.apache.org/ns/synapse" name="tenant1_http" context="/wso001/services/ten1">
    <resource methods="POST" uri-template="/{streamId}">
        <inSequence>
            <log level="full">
                <property name="streamId_src" expression="get-property('uri.var.streamId')"/>
                <property name="sequence" value="IN"/>
            </log>
            <property name="FORCE_SC_ACCEPTED" value="true" scope="axis2" type="STRING"/>
            <iterate xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" continueParent="true" preservePayload="true" attachPath="$body/jsonObject" expression="$body/jsonObject/Values" sequential="true">
                <target>
                    <sequence>
                        <log level="full">
                            <property name="streamId_src" expression="get-property('uri.var.streamId')"/>
                            <property name="sequence" value="IN"/>
                        </log>
                        <call-template target="SendToMessageBrokerSequence" description="">
                            <with-param name="mb_url" value="mb.internal.jms.url"/>
                            <with-param name="mb_user" value="mb.internal.user"/>
                            <with-param name="mb_pwd" value="mb.internal.pwd"/>
                            <with-param name="mb_destination_name" value="{fn:concat('input.ten1.',fn:get-property('uri.var.streamId'))}"/>
                            <with-param name="mb_destination_type" value="queue"/>
                        </call-template>
                        <send/>
                    </sequence>
                </target>
            </iterate>
        </inSequence>
        <outSequence>
            <log level="full">
                <property name="streamId" expression="get-property('uri.var.streamId')"/>
                <property name="sequence" value="OUT"/>
            </log>
        </outSequence>
        <faultSequence>
            <call-template target="SendToMessageBrokerAndRespondErrorSequence" description="">
                <with-param name="mb_url" value="mb.external.jms.url"/>
                <with-param name="mb_user" value="mb.external.user"/>
                <with-param name="mb_pwd" value="mb.external.pwd"/>
                <with-param name="mb_destination_name" value="{{fn:concat('output.ten1.','errors')}}"/>
                <with-param name="mb_destination_type" value="topic"/>
                <with-param name="error_name" value="Stream unknown"/>
                <with-param name="error_code" value="E011"/>
            </call-template>
        </faultSequence>
    </resource>
    <handlers>
        <handler class="org.csi.yucca.realtime.authhandler.AuthenticationHandler">
            <property name="username" value="user"/>
            <property name="password" value="mypass"/>
        </handler>
    </handlers>
</api>
