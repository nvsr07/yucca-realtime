<?xml version="1.0" encoding="UTF-8"?>
<proxy xmlns="http://ws.apache.org/ns/synapse" name="__tenant___mqtt" transports="jms" startOnLoad="true" trace="disable">
    <target>
        <inSequence>
            <property name="streamId" expression="json-eval($.Stream)" scope="default" type="STRING"/>
            <property name="sensorId" expression="json-eval($.Sensor)" scope="default" type="STRING"/>
            <log level="full">
                <property name="streamId_src" expression="get-property('streamId')"/>
                <property name="sequence" value="IN"/>
            </log>
            <call-template target="ValidateMessage" description="">
                <with-param name="schemaToValidate" value="{fn:concat('gov:xsd/',fn:get-property('sensorId'),'_',fn:get-property('streamId'),'Types.xsd')}"/>
            </call-template>
            <iterate xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" continueParent="true" preservePayload="true" attachPath="$body/jsonObject" expression="$body/jsonObject/Values" sequential="true">
                <target>
                    <sequence>
                        <call-template target="SendToMessageBrokerSequence" description="">
                            <with-param name="mb_url" value="mb.internal.jms.url"/>
                            <with-param name="mb_user" value="mb.internal.user"/>
                            <with-param name="mb_pwd" value="mb.internal.pwd"/>
                            <with-param name="mb_destination_name" value="{fn:concat('input.__tenant__.',fn:get-property('sensorId'),'_',fn:get-property('streamId'))}"/>
                            <with-param name="mb_destination_type" value="topic"/>
                        </call-template>
                        <send/>
                    </sequence>
                </target>
            </iterate>
        </inSequence>
        <outSequence>
            <log level="full">
                <property name="streamId" expression="get-property('streamId')"/>
                <property name="sequence" value="OUT"/>
            </log>
        </outSequence>
        <faultSequence>
            <call-template target="SendToMessageBrokerSequence" description="">
                <with-param name="mb_url" value="mb.external.jms.url"/>
                <with-param name="mb_user" value="mb.external.user"/>
                <with-param name="mb_pwd" value="mb.external.pwd"/>
                <with-param name="mb_destination_name" value="{{fn:concat('output.__tenant__.','errors')}}"/>
                <with-param name="mb_destination_type" value="topic"/>
            </call-template>
        </faultSequence>
    </target>
    <parameter name="transport.jms.ContentType">
        <rules>
            <jmsProperty>contentType</jmsProperty>
            <default>application/json</default>
        </rules>
    </parameter>
    <parameter name="transport.jms.DestinationType">queue</parameter>
    <parameter name="transport.jms.Destination">VirtualQueueConsumer.esbin.input.__tenant__</parameter>
</proxy>
